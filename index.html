<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hey Dad, Let&apos;s Talk! — Memory Journal by Aleri Lizaro</title>

  <!-- (необязательно, но ускоряет) DNS/TLS подготовка к TikTok -->
  <link rel="preconnect" href="https://analytics.tiktok.com" crossorigin>

  <!-- TikTok Pixel: single, idempotent loader -->
  <script>
  (function (w, d, lib, pixelId) {
    // Не шлём события с локалки
    var isLocal = (w.location.hostname === 'localhost' || w.location.hostname === '127.0.0.1');
    if (isLocal) return;

    // Гард: если уже грузили — выходим
    if (w.__tiktokPixelLoaded) return;
    w.__tiktokPixelLoaded = true;

    var q = w[lib] = w[lib] || [];
    q.methods = ["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"];
    q.setAndDefer = function (obj, method) {
      obj[method] = function () { obj.push([method].concat([].slice.call(arguments, 0))); };
    };
    for (var i = 0; i < q.methods.length; i++) q.setAndDefer(q, q.methods[i]);

    q.load = function (id, opts) {
      var u = "https://analytics.tiktok.com/i18n/pixel/events.js";
      q._i = q._i || {}; q._i[id] = q._i[id] || []; q._i[id]._u = u;
      q._t = q._t || {}; q._t[id] = +new Date;
      q._o = q._o || {}; q._o[id] = opts || {};

      var s = d.createElement("script");
      s.type = "text/javascript";
      s.async = true;
      s.src = u + "?sdkid=" + id + "&lib=" + lib;
      var x = d.getElementsByTagName("script")[0];
      x.parentNode.insertBefore(s, x);
    };

    // Включить подробные логи SDK по параметру ?ttqdebug=1
    if (/\bttqdebug=1\b/.test(w.location.search)) {
      try { q.debug && q.debug(); } catch (_) {}
    }

    q.load(pixelId);
    q.page();
  })(window, document, "ttq", "D2VA91BC77UD68QFAUFG");
  </script>
  <!-- /TikTok Pixel -->
</head>
<body>
  <div id="root"></div>

  <!-- Ваш бандл (Vite) -->
  <script type="module" src="/src/main.tsx"></script>

  <!-- Track Amazon clicks (amazon.*, amzn.to, a.co) -->
  <script>
  (function () {
    if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') return;

    // Ловим разные домены/укоротители Amazon
    const AMAZON_RE = /(^https?:\/\/)?([^\/]+\.)?(amazon\.[a-z.]+|amzn\.to|a\.co)\//i;

    document.addEventListener('click', function (e) {
      const a = e.target && e.target.closest ? e.target.closest('a[href]') : null;
      if (!a || !a.href || !AMAZON_RE.test(a.href)) return;
      if (!(window.ttq && typeof ttq.track === 'function')) return;

      const href = a.href;

      try {
        ttq.track('ClickButton', {
          button: 'amazon',
          url: href,
          book: document.title
        });
      } catch (_) {}

      // Если это обычный клик в той же вкладке — задержим навигацию на 120 мс,
      // чтобы дать SDK отправить событие.
      const sameTab = (!a.target || a.target === '_self') &&
                      e.button === 0 && !e.metaKey && !e.ctrlKey && !e.shiftKey && !e.altKey;

      if (sameTab) {
        e.preventDefault();
        setTimeout(function () { location.href = href; }, 120);
      }
    }, { capture: true });
  })();
  </script>
</body>
</html>
